---
title: "NHL_JSON"
author: "Zack Vaskalis"
date: "6/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r LoadLibraries, include=FALSE, message=FALSE, echo=TRUE, results='hide'}
library(tidyverse)
library(pipeR)
library(DT)
library(knitr)
library(dplyr)
library(jsonlite)
library(httr)
library(ggplot2)
#library(readr)
#library(convertr)
#library(ggplot2)
#library(bigrquery)
#library(DBI)
#library(RSQLite)
#library(tidyjson)
#library(readr)
#library(convertr)
#library(DBI)
#library(RSQLite)
```

```{r franchise, echo=TRUE}
#Function to get Franchises
  getFranchises <- function(...)
  {
#franchise json data.  Set up components of URL for API query using GET() function
    query_prefix <- 'https://records.nhl.com/site/api'
    query_suffix <- '/franchise'
    franchiseJSON <- GET(paste0(query_prefix,query_suffix))

#Transform Data from JSON to a data frame
    franchiseData <- fromJSON(content(franchiseJSON,"text", encoding = "UTF-8"),flatten = TRUE) 

#Rename id to franchiseID
    franchiseData <- rename(franchiseData$data, franchiseId = id)
    franchiseData

#Reorganize the data frame with columns in a more usable order
    franchiseData %>% select(mostRecentTeamId, franchiseId, teamPlaceName, teamCommonName, firstSeasonId, lastSeasonId) %>%
      arrange(teamPlaceName) %>>% (~ franchiseData)
    franchiseDT <- datatable(franchiseData, rownames = FALSE)

#Initialize franchiseSelection Table for user to be able to see correct franchise ID for functions #3 - 5.
    franchiseSelection <- franchiseData

#return Data
    return(list(franchiseDT,invisible(franchiseSelection)))
  }
```

```{r callgetFranchise, echo=TRUE}
  getFranchises()[2]
```

```{r franchiseTotals, echo=TRUE}
#function to get Franchise Totals
  getFranchiseTotals <- function(...)
  {
#franchise team totals json data.  Set up components of URL for API query using GET() function
    query_prefix <- 'https://records.nhl.com/site/api'
    query_suffix <- '/franchise-team-totals'

#Get JSON Data
    franchiseTeamTotsJSON <- GET(paste0(query_prefix,query_suffix))
    franchiseTeamTotsData <- fromJSON(content(franchiseTeamTotsJSON,"text", encoding = "UTF-8"),flatten = TRUE)

#Reorganize the data frame with columns in a more usable order
    franchiseTeamTotsDataTBL <- tibble::as_tibble(franchiseTeamTotsData)
    franchiseTeamTotsDataTBL$data %>% select(franchiseId, teamName, triCode, wins, losses, ties, overtimeLosses, shutouts, shootoutWins,
                                             shootoutLosses, penaltyMinutes, points, pointPctg, homeWins, homeLosses, homeTies,
                                             homeOvertimeLosses, roadWins, roadLosses, roadTies, roadOvertimeLosses, gameTypeId,
                                             gamesPlayed, goalsAgainst, goalsFor, id, teamId, activeFranchise, firstSeasonId, lastSeasonId) %>%
      arrange(teamName) %>>% (~ franchiseTeamTotsDataTBL)

#return Data
    return(franchiseTeamTotsDataTBL)
  }
```

```{r callgetFranchiseTotals, echo=TRUE}
  datatable(getFranchiseTotals())
```

```{r listOfFranchises, echo=TRUE}
  franchiseSelection <- getFranchises()[2]
  franchiseSelection[[1]] %>% select(franchiseId, teamPlaceName, teamCommonName) %>% arrange(teamPlaceName) %>%
    datatable(franchiseSelection,rownames = FALSE, options = list(autoWidth = TRUE, columnDefs = list(list(width = '50px'))))
```

```{r franchiseSpecificTotals, echo=TRUE}
#Function to get Franchise Specific Totals
  getFranchiseSpecificTotals <- function(FranID, ...)
  {
#Specific franchise team totals json data
    query_prefix <- 'https://records.nhl.com/site/api'
    query_suffix <- '/franchise-season-records?cayenneExp=franchiseId='

#Get Specific Team Input from User
    specific_franchiseID <- FranID

#Get JSON Data
    franchiseIDTeamTotsDataJSON <- GET(paste0(query_prefix,query_suffix,specific_franchiseID))
    franchiseIDTeamTotsData <- fromJSON(content(franchiseIDTeamTotsDataJSON,"text", encoding = "UTF-8"),flatten = TRUE)

#Reorganize the data frame with columns in a more usable order
    franchiseIDTeamTotsDataTBL <- tibble::as_tibble(franchiseIDTeamTotsData)
    franchiseIDTeamTotsDataTBL$data %>% select(franchiseName, franchiseId, id:winlessStreakDates) %>>% (~ franchiseIDTeamTotsDataTBL)

#Return Data    
    return(franchiseIDTeamTotsDataTBL)
  }
```

```{r callgetFranchiseSpecificTotals, echo=TRUE}
#Two test function calls - one for my favorite team, GO PENS! & one for the hometown favorite Hurricanes!
#function to pull records for Pittsburgh Penguins

  datatable(t(getFranchiseSpecificTotals(17)), colnames = "")

#Function to pull records for Carolina Hurricanes

  datatable(t(getFranchiseSpecificTotals(26)), colnames = "")
```

```{r franchiseGoalieRecords, echo=TRUE}
#Function to get Franchise Goalie Records
  getFranchiseGoalieRecords <- function(FranID, ...)
  {
#Specific franchise Goalie Records json data
    query_prefix <- 'https://records.nhl.com/site/api'
    query_suffix <- '/franchise-goalie-records?cayenneExp=franchiseId='

#Get Specific Team Input from User
    specific_franchiseID <- FranID

#Get JSON Data
    franchiseIDGoalieJSON <- GET(paste0(query_prefix,query_suffix,specific_franchiseID))
    franchiseIDGoalieData <- fromJSON(content(franchiseIDGoalieJSON,"text", encoding = "UTF-8"),flatten = TRUE)

#Reorganize the data frame with columns in a more usable order

    goalieDF <- franchiseIDGoalieData$data
    goalieDF %>% select(franchiseId, franchiseName, firstName, lastName, gamesPlayed, wins, losses, ties,
                        mostSavesOneGame, mostShotsAgainstOneGame, mostGoalsAgainstOneGame, id:wins) %>>% (~ goalieDF)

#Return data
    return(goalieDF)
  }
```

```{r callgetFranchiseGoalieRecords, echo=TRUE}
#Two test function calls - one for my favorite team, GO PENS! & one for the hometown favorite Hurricanes!
#function to pull records for Pittsburgh Penguins

  datatable(getFranchiseGoalieRecords(17))

#Function to pull records for Carolina Hurricanes

  datatable(getFranchiseGoalieRecords(26))
```

```{r franchiseSkaterRecords, echo=TRUE}
#Function to get Franchise Goalie Records
  getFranchiseSkaterRecords <- function(FranID, ...)
  {

#Specific franchise Skater Records json data
    query_prefix <- 'https://records.nhl.com/site/api'
    query_suffix <- '/franchise-skater-records?cayenneExp=franchiseId='

#Get Specific Team Input from User
    specific_franchiseID <- FranID
    
#Get JSON Data
    franchiseIDSkaterJSON <- GET(paste0(query_prefix,query_suffix,specific_franchiseID))
    franchiseIDSkaterData <- fromJSON(content(franchiseIDSkaterJSON,"text", encoding = "UTF-8"),flatten = TRUE)

#Reorganize the data frame with columns in a more usable order

    skaterDF <- franchiseIDSkaterData$data
    skaterDF %>% select(franchiseId, franchiseName, firstName, lastName, positionCode, gamesPlayed, goals, assists, penaltyMinutes,
                        mostGoalsOneGame, mostAssistsOneGame, mostPenaltyMinutesOneSeason, id:seasons) %>% arrange(desc(goals)) %>>% (~ skaterDF)
    
#Return Data
    return(skaterDF)
  }
```

```{r callgetFranchiseSkaterRecords, echo=TRUE}
#Two test function calls - one for my favorite team, GO PENS! & one for the hometown favorite Hurricanes!
#function to pull records for Pittsburgh Penguins

  datatable(getFranchiseSkaterRecords(17))

#Function to pull records for Carolina Hurricanes

  datatable(getFranchiseSkaterRecords(26))
```



